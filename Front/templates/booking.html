<!DOCTYPE html>
<html lang="ru">

<head>
    <title>Сервис бронирования</title>
</head>
<body onload="function1();writeUserData();checkJwt()">
    {% include 'header.html' %} 
    <main></main>
        <h1>Бронирование</h1>
        <div>
            <p>Имя клиента:</p>
            <input id = "userFirstName"><br>
            <p>Фамилия клиента:</p>
            <input id = "userLastName"><br>
            <p id = "masterName"></p>
            <p id = "address"></p>
            <p id = "time"></p>
            <p id = "price"></p><br>
            <button>Перейти к оплате</button>
        </div>
    </main>
    <footer>
        
    </footer>
</body>

<script>
async function function1() {
    var ul = document.getElementById("header");
    var li = document.createElement("li");

    if (!document.cookie.includes("jwt")) {
        
        li.innerHTML = `<a href="/login/">Вход</a>`;
        ul.appendChild(li);
    }
    else{
        li.innerHTML = `
        <a href="javascript:logout();">Выйти</a>
        `;
        ul.appendChild(li);
    }
}

function logout(){
    let newCookie = "";
    let split = document.cookie.split(';');
    for(var i = 0; i < split.length; i++){
        console.log(newCookie);
        if (split[i].includes("jwt=")){
            newCookie += split[i] + ";max-age=-1;";
        }
        else{
            newCookie += split[i];
        }
    }
    document.cookie = newCookie;
    console.log(document.cookie);

    location.reload()
}

async function writeUserData(){
    const userFirstName = document.querySelector("#userFirstName");
    const userLastName = document.querySelector("#userLastName");
    const masterName = document.querySelector("#masterName");
    const address = document.querySelector("#address")
    const time = document.querySelector("#time");
    const price = document.querySelector("#price")

    const splittedHref = window.location.href.split('/');
    const slot_id = splittedHref[splittedHref.length - 2];
    const d = {
            method: "POST",
            headers: { "Content-Type": "application/json"},
            body: JSON.stringify({"jwt" : document.cookie}),
        };
    
    console.log(document.cookie)

    data = await fetch(`/api/get-booking-data/${slot_id}`, d).then(
        (response) => response.json()
    );
    console.log(2)

    userFirstName.value = data["firstName"]
    userLastName.value = data["lastName"]
    masterName.textContent = `Ваш мастер: ${data["masterName"]}`
    address.textContent = `Адрес: ${data["address"]}`
    time.textContent = `Время записи: ${data["time"]}`
    price.textContent = `Цена: ${data["price"]}`

}

function checkJwt(){
    if (!document.cookie.includes("jwt")) {
        window.location.replace('/addresses/')
    }
}
</script>

</html>